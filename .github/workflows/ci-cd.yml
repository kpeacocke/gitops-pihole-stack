---
name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker compose config --quiet

      - name: Check for required files
        run: |
          test -f docker-compose.yml
          test -f unbound/unbound.conf
          test -f unbound/root.hints
          test -f pihole/99-custom.conf

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test .env file
        run: |
          cat << EOF > .env
          ADMIN_PASSWORD=test_password
          HOST_IP=127.0.0.1
          REP_ADMIN_PASSWORD=test_password
          EOF

      - name: Override network_mode for CI testing
        run: |
          # Replace network_mode: host with bridge networking for CI
          sed -i 's/network_mode: host/# network_mode: host # Disabled for CI/g' docker-compose.yml
          # Remove entire depends_on block for CI testing
          sed -i '/depends_on:/,/condition: service_healthy/d' docker-compose.yml

      - name: Start services
        run: |
          docker compose up -d --wait || true

      - name: Wait for containers to start
        run: |
          echo "Waiting for containers to initialize..."
          sleep 30

      - name: Check Unbound is running
        run: |
          docker ps -a
          if docker ps | grep -q unbound; then
            echo "Unbound container is running"
            docker exec unbound unbound-checkconf /etc/unbound/unbound.conf || echo "Config check failed but container is running"
          else
            echo "Unbound container failed to start"
            docker logs unbound
            exit 1
          fi

      - name: Check Pi-hole is running
        run: |
          if docker ps | grep -q pihole; then
            echo "Pi-hole container is running"
            docker exec pihole pgrep pihole-FTL || echo "FTL check failed but container is running"
          else
            echo "Pi-hole container failed to start"
            docker logs pihole
            exit 1
          fi

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== Unbound logs ==="
          docker logs unbound || true
          echo "=== Pi-hole logs ==="
          docker logs pihole || true

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create release tag and GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v$(date +'%Y.%m.%d')-${GITHUB_SHA::7}"
          echo "Creating release $TAG"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and push tag
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          
          # Create GitHub release using gh CLI
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes "Automated release for Pi-hole stack deployment" \
            --latest

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: release
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      matrix:
        host: [terror, harmony]
    steps:
      - name: Trigger Portainer webhook for ${{ matrix.host }}
        run: |
          if [ "${{ matrix.host }}" = "terror" ]; then
            WEBHOOK_URL="${{ secrets.PORTAINER_WEBHOOK_TERROR_URL }}"
          else
            WEBHOOK_URL="${{ secrets.PORTAINER_WEBHOOK_HARMONY_URL }}"
          fi
          
          if [ -z "$WEBHOOK_URL" ]; then
            echo "ERROR: Webhook URL is empty for ${{ matrix.host }}"
            exit 1
          fi
          
          echo "Triggering deployment for ${{ matrix.host }}..."
          echo "Webhook URL: ${WEBHOOK_URL:0:50}..." # Show first 50 chars only
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$WEBHOOK_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "HTTP Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✓ Deployment triggered successfully for ${{ matrix.host }}"
          else
            echo "✗ Failed to trigger deployment for ${{ matrix.host }}"
            exit 1
          fi
