---
services:
  unbound:
    image: klutchell/unbound:latest
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./unbound/unbound.conf:/etc/unbound/unbound.conf:ro
      - ./unbound/root.hints:/var/unbound/root.hints:ro
    healthcheck:
      test: ["CMD-SHELL", "unbound-checkconf /etc/unbound/unbound.conf >/dev/null 2>&1 && nc -z 127.0.0.1 5335"]
      interval: 30s
      timeout: 5s
      retries: 5

  pihole:
    image: pihole/pihole:latest
    network_mode: host
    restart: unless-stopped
    environment:
      TZ: "Australia/Sydney"
      FTLCONF_webserver_api_password: "${ADMIN_PASSWORD}"
      FTLCONF_dns_upstreams: "127.0.0.1#5335"
      FTLCONF_dns_listeningMode: "all"
      FTLCONF_dns_reply_host_IPv4: "${HOST_IP}"
      FTLCONF_dns_reply_host_force4: "true"
      FTLCONF_database_maxDBdays: "7"
      FTLCONF_misc_etc_dnsmasq_d: "true"
    volumes:
      - pihole-etc:/etc/pihole
      - pihole-logs:/var/log
      - ./pihole:/etc/dnsmasq.d:ro
    cap_add:
      - NET_ADMIN
    dns:
      - 127.0.0.1
      - 1.1.1.1

  nebula-sync:
    image: ghcr.io/lovelaze/nebula-sync:latest
    restart: unless-stopped
    profiles: ["nebula"]   # ðŸ‘ˆ only runs if profile is active
    environment:
      PRIMARY: "http://192.168.5.52|${ADMIN_PASSWORD}"
      REPLICAS: "http://192.168.5.54|${ADMIN_PASSWORD}"
      FULL_SYNC: "true"
      RUN_GRAVITY: "true"
      CRON: "*/30 * * * *"

volumes:
  pihole-etc:
  pihole-logs: