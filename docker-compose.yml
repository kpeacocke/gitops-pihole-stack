---
# Docker Compose configuration for Pi-hole with Unbound DNS resolver
# Ensure to create a .env file with required variables: ADMIN_PASSWORD, HOST_IP, REP_ADMIN_PASSWORD
services:
  # Unbound DNS resolver for improved privacy and performance
  unbound:
    image: klutchell/unbound:latest
    container_name: unbound
    network_mode: host
    restart: unless-stopped
    environment:
      TZ: "Australia/Sydney"
    command: ["-d", "-c", "/etc/unbound/unbound.conf"]
    volumes:
      - ./unbound/unbound.conf:/etc/unbound/unbound.conf:ro
      - ./unbound/root.hints:/var/unbound/root.hints:ro
      - unbound:/var/unbound/key
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "-p", "5335", "google.com"]
      interval: 30s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Pi-hole ad blocker and DNS server
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    network_mode: host
    restart: unless-stopped
    environment:
      TZ: "Australia/Sydney"
      FTLCONF_webserver_api_password: "${ADMIN_PASSWORD}"
      FTLCONF_dns_upstreams: "127.0.0.1#5335"
      FTLCONF_dns_listeningMode: "all"
      FTLCONF_dns_reply_host_IPv4: "${HOST_IP}"
      FTLCONF_dns_reply_host_force4: "true"
      # Database and log management to prevent disk space issues
      FTLCONF_database_maxDBdays: "7"
      FTLCONF_files_log_dnsmasq: "/var/log/pihole/pihole.log"
      FTLCONF_files_log_ftl: "/var/log/pihole/FTL.log"
      FTLCONF_files_log_webserver: "/var/log/pihole/webserver.log"
      FTLCONF_misc_etc_dnsmasq_d: "true"
      # Rotate logs daily and keep only 3 days of compressed logs
      DNSMASQ_LISTENING: "all"
      PIHOLE_DNS_1: "127.0.0.1#5335"
    volumes:
      - pihole-etc:/etc/pihole
      - pihole-logs:/var/log
      - ./pihole:/etc/dnsmasq.d:ro
    cap_add:
      - NET_ADMIN
    dns:
      - 127.0.0.1
      - 1.1.1.1
    depends_on:
      unbound:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api.php?status"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional nebula-sync for syncing Pi-hole configurations across instances
  nebula-sync:
    image: ghcr.io/lovelaze/nebula-sync:latest
    container_name: nebula-sync
    restart: unless-stopped
    profiles: ["nebula"]
    environment:
      PRIMARY: "http://192.168.5.52|${ADMIN_PASSWORD}"
      REPLICAS: "http://192.168.5.54|${REP_ADMIN_PASSWORD}"
      FULL_SYNC: "false"
      RUN_GRAVITY: "true"
      CRON: "*/15 * * * *"
      CLIENT_RETRY_DELAY_SECONDS: 15
      CLIENT_TIMEOUT_SECONDS: 45
      SYNC_GRAVITY_GROUP: true
      SYNC_GRAVITY_AD_LIST: true
      SYNC_GRAVITY_AD_LIST_BY_GROUP: true
      SYNC_GRAVITY_DOMAIN_LIST: true
      SYNC_GRAVITY_DOMAIN_LIST_BY_GROUP: true
      SYNC_GRAVITY_CLIENT: true
      SYNC_GRAVITY_CLIENT_BY_GROUP: true
      SYNC_CONFIG_NTP: true
      SYNC_CONFIG_DNS: true
      SYNC_CONFIG_DNS_EXCLUDE: "interface,reply.host.force4,reply.host.IPv4,reply.host.force6,reply.host.IPv6"

volumes:
  pihole-etc:
  pihole-logs:
  unbound: